<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ í™˜ìœ¨ ì•Œë¦¬ë¯¸ (Pro)</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: white; text-align: center; padding: 20px; transition: background 0.3s; }
        
        /* ì•Œë¦¼ íš¨ê³¼ */
        .alert-bg { animation: flashRed 1s infinite; }
        @keyframes flashRed { 0% {background:#121212;} 50% {background:#d32f2f;} 100% {background:#121212;} }

        h1 { color: #4CAF50; margin-bottom: 5px; font-size: 1.2rem; }
        
        /* í™˜ìœ¨ ë°•ìŠ¤ */
        .rate-box { background: #1e1e1e; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 320px; border: 1px solid #333; }
        #currentRate { font-size: 3.5rem; font-weight: bold; margin: 10px 0; letter-spacing: -1px; }
        /* ìƒìŠ¹/í•˜ë½ ìƒ‰ìƒ */
        .up { color: #ff5252; }
        .down { color: #448aff; }
        
        .sub-text { color: #888; font-size: 0.9rem; }
        #errorMsg { display: none; color: #ff5252; background: #3e1b1b; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px; }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-area { max-width: 350px; margin: 0 auto; }
        input { padding: 12px; border-radius: 8px; border: none; font-size: 1.2rem; width: 100px; text-align: center; background: #333; color: white; margin-right: 5px; }
        button { padding: 12px 18px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; font-weight: bold; }
        .btn-add { background: #2196F3; color: white; }
        .btn-perm { width: 100%; background: #4CAF50; color: white; margin-bottom: 15px; padding: 15px; }

        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #222; padding: 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .del-btn { background: #ff5252; color: white; padding: 5px 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <h1>USD/KRW ì‹¤ì‹œê°„(Tick)</h1>

    <div class="rate-box">
        <div id="currentRate">Loading...</div>
        <div class="sub-text" id="timeInfo">ì ‘ì† ì¤‘...</div>
        <div id="errorMsg">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>
    </div>

    <div class="control-area">
        <button class="btn-perm" onclick="requestNoti()">ğŸ”” ì•Œë¦¼ ê¶Œí•œ ì¼œê¸° (í•„ìˆ˜)</button>

        <div>
            <input type="number" id="targetInput" placeholder="1480" inputmode="decimal">
            <button class="btn-add" onclick="addTarget()">ëª©í‘œ ì¶”ê°€</button>
        </div>

        <ul id="targetList"></ul>
    </div>

    <script>
        let targets = JSON.parse(localStorage.getItem('myTargets') || '[]');
        let lastPrice = 0;

        init();
        function init() {
            renderList();
            getRate();
            // 3ì´ˆë§ˆë‹¤ ê³ ì† ê°±ì‹  (ì£¼ì‹ì°½ ì²˜ëŸ¼)
            setInterval(getRate, 3000); 
        }

        // â˜… í•µì‹¬ ë³€ê²½: ë‘ë‚˜ë¬´(Upbit) ì‹¤ì‹œê°„ ì™¸í™˜ API ì‚¬ìš©
        async function getRate() {
            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ ì‹œê°„ê°’(?t=...)ì„ ë’¤ì— ë¶™ì„
                const res = await fetch(`https://quotation-api-cdn.dunamu.com/v1/forex/recent?codes=FRX.KRWUSD&t=${Date.now()}`);
                const data = await res.json();
                
                // ë‘ë‚˜ë¬´ ë°ì´í„° í˜•ì‹: [{basePrice: 1473.0, ...}]
                const rate = data[0].basePrice; 
                const change = data[0].change; // RISE(ìƒìŠ¹), FALL(í•˜ë½), EVEN(ë³´í•©)
                const timeStr = data[0].time; // "18:24:00" í˜•ì‹

                // í™”ë©´ ì—…ë°ì´íŠ¸
                const rateEl = document.getElementById('currentRate');
                rateEl.innerText = rate.toLocaleString();
                
                // ê°€ê²© ë³€ë™ ìƒ‰ìƒ (ë¹¨ê°•/íŒŒë‘)
                rateEl.className = change === 'RISE' ? 'up' : (change === 'FALL' ? 'down' : '');

                document.getElementById('timeInfo').innerText = `ê°±ì‹ : ${timeStr.substring(0,5)}`;
                document.getElementById('errorMsg').style.display = 'none';

                checkAlert(rate);
                lastPrice = rate;

            } catch (error) {
                console.error(error);
                // ì—ëŸ¬ë‚˜ë©´ ê¸°ì¡´ ê°’ ìœ ì§€í•˜ë˜ ë©”ì‹œì§€ë§Œ ë„ì›€
                // document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function checkAlert(current) {
            targets.forEach(t => {
                if (t.notified) return;
                
                // ì˜¤ì°¨ë²”ìœ„ 0.5ì› ì´ë‚´ ì ‘ì´‰ ì‹œ
                if (Math.abs(current - t.price) <= 0.5) {
                    doNotify(t.price, current);
                    t.notified = true;
                    saveData();
                    renderList();
                }
            });
        }

        function doNotify(targetPrice, currentPrice) {
            document.body.classList.add('alert-bg');
            setTimeout(() => document.body.classList.remove('alert-bg'), 3000);

            if (Notification.permission === "granted") {
                new Notification(`âš¡ í™˜ìœ¨ ë„ë‹¬: ${targetPrice}ì›`, {
                    body: `í˜„ì¬ ${currentPrice}ì› í„°ì¹˜!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/2535/2535079.png",
                    requireInteraction: true 
                });
            }
        }

        function addTarget() {
            const val = parseFloat(document.getElementById('targetInput').value);
            if (!val) return;
            targets.push({ price: val, notified: false });
            saveData();
            renderList();
            document.getElementById('targetInput').value = '';
        }

        function removeTarget(idx) {
            targets.splice(idx, 1);
            saveData();
            renderList();
        }

        function renderList() {
            const list = document.getElementById('targetList');
            list.innerHTML = '';
            targets.forEach((t, i) => {
                const li = document.createElement('li');
                li.style.opacity = t.notified ? "0.5" : "1";
                li.innerHTML = `<span>ğŸ¯ ${t.price}ì› ${t.notified ? "(ì™„ë£Œ)" : ""}</span> <button class="del-btn" onclick="removeTarget(${i})">ì‚­ì œ</button>`;
                list.appendChild(li);
            });
        }

        function saveData() {
            localStorage.setItem('myTargets', JSON.stringify(targets));
        }

        function requestNoti() {
            Notification.requestPermission().then(perm => {
                if(perm === 'granted') alert("ì‹¤ì‹œê°„ ì•Œë¦¼ ì¤€ë¹„ ì™„ë£Œ!");
            });
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
