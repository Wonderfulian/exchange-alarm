<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í™˜ìœ¨ ì•Œë¦¬ë¯¸ (Debug)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: white; text-align: center; padding: 20px; }
        .rate-box { background: #1e1e1e; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 320px; border: 1px solid #333; }
        #currentRate { font-size: 3rem; font-weight: bold; margin: 10px 0; }
        #debugLog { font-size: 0.8rem; color: #ffeb3b; text-align: left; background: #000; padding: 10px; margin-top: 20px; border-radius: 5px; min-height: 100px; overflow-y: scroll; font-family: monospace; }
        button { padding: 15px; width: 100%; max-width: 320px; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>í™˜ìœ¨ ì•Œë¦¬ë¯¸ (ì§„ë‹¨ëª¨ë“œ)</h1>

    <div class="rate-box">
        <div id="currentRate">ì¤€ë¹„ì¤‘...</div>
        <div id="status">ë°ì´í„° ìš”ì²­ ëŒ€ê¸°</div>
    </div>

    <button onclick="reqPerm()">ğŸ”” ì•Œë¦¼ ê¶Œí•œ ì¼œê¸°</button>
    <button onclick="window.location.reload()" style="background:#4caf50; margin-top:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨ (ìºì‹œì‚­ì œ)</button>

    <div id="debugLog">Logs will appear here...</div>

    <script>
        // í™”ë©´ì— ë¡œê·¸ ì°ëŠ” í•¨ìˆ˜
        function log(msg) {
            const box = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        }

        // 1. ì¢€ë¹„ ìºì‹œ(Service Worker) ê°•ì œ ì‚­ì œ (ê°€ì¥ ì¤‘ìš”)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                    log("âœ… ê¸°ì¡´ ìºì‹œ(SW) ì‚­ì œ ì„±ê³µ");
                } 
                if(registrations.length === 0) log("â„¹ï¸ ì‚­ì œí•  ìºì‹œ ì—†ìŒ (ê¹¨ë—í•¨)");
            }).catch(err => log("âš ï¸ ìºì‹œ ì‚­ì œ ì‹¤íŒ¨: " + err));
        }

        // 2. í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
        start();

        function start() {
            log("ğŸš€ ë°ì´í„° ë¡œë”© ì‹œì‘...");
            getRate();
            setInterval(getRate, 5000);
        }

        async function getRate() {
            // A. ë‘ë‚˜ë¬´(Upbit) ì‹œë„
            try {
                // log("ì‹œë„ 1: Upbit API ì ‘ì†...");
                const res = await fetch(`https://quotation-api-cdn.dunamu.com/v1/forex/recent?codes=FRX.KRWUSD&t=${Date.now()}`);
                if (!res.ok) throw new Error("Status " + res.status);
                
                const data = await res.json();
                const rate = data[0].basePrice;
                
                document.getElementById('currentRate').innerText = rate.toLocaleString();
                document.getElementById('status').innerText = "âš¡ ì‹¤ì‹œê°„ (Upbit)";
                document.getElementById('status').style.color = "#4caf50";
                
                // log("âœ… Upbit ì„±ê³µ: " + rate);
                checkAlert(rate); // ì•Œë¦¼ ì²´í¬

            } catch (e1) {
                log("âŒ Upbit ì‹¤íŒ¨: " + e1.message);
                
                // B. ì‹¤íŒ¨ ì‹œ Open API ì‹œë„ (ë¹„ìƒìš©)
                try {
                    log("ì‹œë„ 2: Open API (ë¹„ìƒë§) ì ‘ì†...");
                    const res2 = await fetch('https://open.er-api.com/v6/latest/USD');
                    const data2 = await res2.json();
                    const rate2 = data2.rates.KRW;

                    document.getElementById('currentRate').innerText = rate2.toFixed(1);
                    document.getElementById('status').innerText = "ğŸŸ¢ ë¹„ìƒëª¨ë“œ ì‘ë™ì¤‘";
                    log("âœ… Open API ì„±ê³µ: " + rate2);
                    checkAlert(rate2);

                } catch (e2) {
                    log("â›” ëª¨ë“  ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„· í™•ì¸ í•„ìš”.");
                    document.getElementById('currentRate').innerText = "ERROR";
                }
            }
        }

        // ì•Œë¦¼ ë¡œì§ (ê°„ì†Œí™”)
        let targets = [1472, 1474, 1480]; // í…ŒìŠ¤íŠ¸ìš© ê°•ì œ ì„¤ì •
        let notified = false;

        function checkAlert(current) {
            // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 1400ì› ì´ìƒì´ë©´ ë¬´ì¡°ê±´ ì•Œë¦¼ í•œë²ˆ ì‹œë„ (ê¶Œí•œ í™•ì¸ìš©)
            // ì‹¤ì œ ë¡œì§ì€ ì—¬ê¸°ì— ë“¤ì–´ê°
        }

        function reqPerm() {
            Notification.requestPermission().then(p => {
                log("ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ: " + p);
                if(p==='granted') new Notification("í…ŒìŠ¤íŠ¸ ì•Œë¦¼", {body:"ì„¤ì • ì™„ë£Œ"});
            });
        }
    </script>
</body>
</html>