<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ í™˜ìœ¨ (Final v3)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: white; text-align: center; padding: 20px; }
        
        /* ì•Œë¦¼ íš¨ê³¼ */
        .alert-bg { animation: flashRed 1s infinite; }
        @keyframes flashRed { 0% {background:#121212;} 50% {background:#d32f2f;} 100% {background:#121212;} }

        h1 { color: #4CAF50; margin-bottom: 5px; font-size: 1.2rem; }
        
        .rate-box { background: #1e1e1e; padding: 25px; border-radius: 20px; margin: 20px auto; max-width: 320px; border: 1px solid #333; }
        #currentRate { font-size: 3.5rem; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
        
        .up { color: #ff5252; }
        .down { color: #448aff; }
        .even { color: #ffffff; }

        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; background: #333; display: inline-block; margin-top: 5px; color: #aaa;}
        .mode-live { color: #fff; border: 1px solid #ff5252; background: #d32f2f; } 
        .mode-safe { color: #fff; border: 1px solid #4caf50; background: #2e7d32; }

        /* ì§„í–‰ ìƒí™© ë¡œê·¸ (ë””ë²„ê¹…ìš©) */
        #debugLog { font-size: 0.7rem; color: #666; margin-top: 10px; height: 20px; }

        .control-area { max-width: 350px; margin: 0 auto; margin-top: 30px;}
        input { padding: 12px; border-radius: 10px; border: none; font-size: 1.2rem; width: 100px; text-align: center; background: #333; color: white; margin-right: 5px; font-weight: bold; }
        button { padding: 12px 18px; border-radius: 10px; border: none; font-size: 1rem; cursor: pointer; font-weight: bold; }
        .btn-add { background: #2196F3; color: white; }
        .btn-perm { width: 100%; background: #4CAF50; color: white; margin-bottom: 15px; padding: 15px; font-size: 1.1rem; }

        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .del-btn { background: #ff5252; color: white; padding: 8px 12px; font-size: 0.8rem; border-radius: 8px; }
    </style>
</head>
<body>

    <h1>USD/KRW ì‹¤ì‹œê°„</h1>

    <div class="rate-box">
        <div id="currentRate">---</div>
        <div id="serverStatus" class="status-badge">ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
        <div id="debugLog">ì´ˆê¸°í™” ì¤‘...</div> </div>

    <div class="control-area">
        <button class="btn-perm" onclick="requestNoti()">ğŸ”” ì•Œë¦¼ ê¶Œí•œ ì¼œê¸°</button>
        <div>
            <input type="number" id="targetInput" placeholder="1480">
            <button class="btn-add" onclick="addTarget()">ëª©í‘œ ì¶”ê°€</button>
        </div>
        <ul id="targetList"></ul>
    </div>

    <script>
        let targets = JSON.parse(localStorage.getItem('myTargets') || '[]');

        // 1. ì¢€ë¹„ ìºì‹œ ì‚­ì œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => reg.unregister());
            });
        }

        init();
        function init() {
            renderList();
            fetchDataLoop(); // ì‹œì‘
            setInterval(fetchDataLoop, 5000); // 5ì´ˆë§ˆë‹¤ ì‹¤í–‰ (ì„œë²„ ë³´í˜¸)
        }

        // â˜… 3ì¤‘ ì•ˆì „ì¥ì¹˜ í•¨ìˆ˜ â˜…
        async function fetchDataLoop() {
            const logEl = document.getElementById('debugLog');
            
            // 1ì°¨ ì‹œë„: Corsproxy.io (ê°€ì¥ ë¹ ë¦„)
            try {
                logEl.innerText = "1ì°¨ ì„œë²„(Fast) ì ‘ì† ì‹œë„...";
                const targetUrl = 'https://quotation-api-cdn.dunamu.com/v1/forex/recent?codes=FRX.KRWUSD';
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}&t=${Date.now()}`;
                
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("1ì°¨ ì‹¤íŒ¨");
                const data = await res.json();
                
                updateScreen(data[0].basePrice, data[0].change, true);
                logEl.innerText = ""; // ì„±ê³µì‹œ ë¡œê·¸ ì§€ì›€
                return; // ì„±ê³µí•˜ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ

            } catch (e1) {
                console.warn("1ì°¨ ì‹¤íŒ¨, 2ì°¨ ì‹œë„...", e1);
                
                // 2ì°¨ ì‹œë„: AllOrigins (ì•ˆì •ì )
                try {
                    logEl.innerText = "2ì°¨ ì„œë²„(Stable) ìš°íšŒ ì‹œë„...";
                    const targetUrl = 'https://quotation-api-cdn.dunamu.com/v1/forex/recent?codes=FRX.KRWUSD';
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&t=${Date.now()}`;
                    
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error("2ì°¨ ì‹¤íŒ¨");
                    const wrapper = await res.json();
                    const data = JSON.parse(wrapper.contents); // íŒŒì‹± ì£¼ì˜

                    updateScreen(data[0].basePrice, data[0].change, true);
                    logEl.innerText = "";
                    return; // ì„±ê³µí•˜ë©´ ì¢…ë£Œ

                } catch (e2) {
                    console.error("2ì°¨ ì‹¤íŒ¨, ë¹„ìƒë§ ê°€ë™", e2);
                    // 3ì°¨ ì‹œë„: OpenAPI (ë¬´ì¡°ê±´ ë¨, ì–´ì œ í™˜ìœ¨)
                    logEl.innerText = "ì‹¤ì‹œê°„ ì‹¤íŒ¨.. ë¹„ìƒë§ ê°€ë™";
                    fallbackAPI();
                }
            }
        }

        async function getRateProxy() {
            try {
                // â–¼â–¼â–¼ ì•„ê¹Œ ë§Œë“  ë¯¸êµ­ ì„œë²„ ì£¼ì†Œë¥¼ ë”°ì˜´í‘œ ì•ˆì— ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼
                const myCloudUrl = 'https://my-rate-server-916720061652.us-central1.run.app'; 
                
                const res = await fetch(myCloudUrl);
                if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");

                const data = await res.json();
                
                // ì•¼í›„ ë°ì´í„°(ê°€ì§œ ì—…ë¹„íŠ¸) ì²˜ë¦¬
                const rate = data[0].basePrice;
                const change = data[0].change;
                const provider = data[0].provider;

                // í™”ë©´ ì—…ë°ì´íŠ¸
                const rateEl = document.getElementById('currentRate');
                const statusEl = document.getElementById('serverStatus');

                rateEl.innerText = rate.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                if (change === 'RISE') rateEl.className = 'up';
                else if (change === 'FALL') rateEl.className = 'down';
                else rateEl.className = 'even';

                statusEl.innerText = `âš¡ ì‹¤ì‹œê°„ (${provider})`;
                statusEl.className = "status-badge mode-live";

                checkAlert(rate);

            } catch (e) {
                console.error("ì ‘ì† ì‹¤íŒ¨:", e);
                document.getElementById('serverStatus').innerText = "ì„œë²„ ì ê²€ ì¤‘";
                fallbackAPI(); // ì‹¤íŒ¨í•˜ë©´ ë¹„ìƒìš© API ê°€ë™
            }
        }

        function updateScreen(price, change, isLive) {
            const rateEl = document.getElementById('currentRate');
            const statusEl = document.getElementById('serverStatus');

            rateEl.innerText = price.toLocaleString();

            if (change === 'RISE') rateEl.className = 'up';
            else if (change === 'FALL') rateEl.className = 'down';
            else rateEl.className = 'even';

            if (isLive) {
                statusEl.innerText = "âš¡ ì‹¤ì‹œê°„ (Upbit)";
                statusEl.className = "status-badge mode-live";
            } else {
                statusEl.innerText = "âš ï¸ ì§€ì—° ì‹œì„¸ (OpenAPI)";
                statusEl.className = "status-badge mode-safe";
            }
            
            checkAlert(price);
        }

        function checkAlert(current) {
            targets.forEach(t => {
                if (t.notified) return;
                if (Math.abs(current - t.price) <= 0.5) {
                    doNotify(t.price, current);
                    t.notified = true;
                    saveData();
                    renderList();
                }
            });
        }

        function doNotify(target, current) {
            document.body.classList.add('alert-bg');
            setTimeout(() => document.body.classList.remove('alert-bg'), 4000);
            if (Notification.permission === "granted") {
                new Notification(`ğŸ’° í™˜ìœ¨ ë„ë‹¬! ${target}ì›`, { body: `í˜„ì¬: ${current}ì›` });
            }
        }

        function addTarget() {
            const val = parseFloat(document.getElementById('targetInput').value);
            if (!val) return;
            targets.push({ price: val, notified: false });
            saveData();
            renderList();
            document.getElementById('targetInput').value = '';
        }

        function removeTarget(idx) {
            targets.splice(idx, 1);
            saveData();
            renderList();
        }

        function renderList() {
            const list = document.getElementById('targetList');
            list.innerHTML = '';
            targets.forEach((t, i) => {
                const li = document.createElement('li');
                li.style.opacity = t.notified ? "0.4" : "1";
                li.innerHTML = `<span>ğŸ¯ ${t.price}ì›</span><button class="del-btn" onclick="removeTarget(${i})">ì‚­ì œ</button>`;
                list.appendChild(li);
            });
        }

        function saveData() { localStorage.setItem('myTargets', JSON.stringify(targets)); }
        function requestNoti() { Notification.requestPermission(); }
    </script>
</body>
</html>