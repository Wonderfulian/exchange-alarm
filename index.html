<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ í™˜ìœ¨ (Final v5)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: white; text-align: center; padding: 20px; }
        
        .alert-bg { animation: flashRed 1s infinite; }
        @keyframes flashRed { 0% {background:#121212;} 50% {background:#d32f2f;} 100% {background:#121212;} }

        h1 { color: #4CAF50; margin-bottom: 5px; font-size: 1.2rem; }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .rate-box { 
            background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
            padding: 30px; 
            border-radius: 25px; 
            margin: 20px auto; 
            max-width: 320px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #currentRate { font-size: 3.5rem; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
        
        .up { color: #ff5252; }
        .down { color: #448aff; }
        .even { color: #ffffff; }

        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; background: #333; display: inline-block; margin-top: 5px; color: #aaa;}
        .mode-live { color: #fff; border: 1px solid #ff5252; background: #d32f2f; } 

        .control-area { max-width: 350px; margin: 0 auto; margin-top: 30px;}
        input { padding: 12px; border-radius: 10px; border: none; font-size: 1.2rem; width: 100px; text-align: center; background: #333; color: white; margin-right: 5px; font-weight: bold; }
        button { padding: 12px 18px; border-radius: 10px; border: none; font-size: 1rem; cursor: pointer; font-weight: bold; }
        .btn-add { background: #2196F3; color: white; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-perm { flex: 1; background: #4CAF50; color: white; font-size: 0.9rem; padding: 10px; }
        .btn-wake { flex: 1; background: #FF9800; color: white; font-size: 0.9rem; padding: 10px; }
        .wake-on { background: #E65100; border: 2px solid #FFF; }

        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .del-btn { background: #ff5252; color: white; padding: 8px 12px; font-size: 0.8rem; border-radius: 8px; }
        .dir-badge { font-size: 0.8rem; padding: 3px 6px; border-radius: 4px; margin-right: 8px; font-weight: bold; }
        .dir-up { background: #ff52521a; color: #ff5252; border: 1px solid #ff5252; }
        .dir-down { background: #448aff1a; color: #448aff; border: 1px solid #448aff; }
    </style>
</head>
<body>

    <h1>USD/KRW ì‹¤ì‹œê°„</h1>

    <div class="rate-box">
        <div id="currentRate">---</div>
        <div id="serverStatus" class="status-badge">ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>

    <div class="control-area">
        <div class="btn-group">
            <button class="btn-perm" onclick="requestNoti()">ğŸ”” ì•Œë¦¼ ê¶Œí•œ</button>
            <button class="btn-wake" id="wakeBtn" onclick="toggleWakeLock()">ğŸ“± í™”ë©´ ì¼œë‘ </button>
        </div>
        
        <div>
            <input type="number" id="targetInput" placeholder="ëª©í‘œê°€">
            <button class="btn-add" onclick="addTarget()">ì¶”ê°€</button>
        </div>
        <ul id="targetList"></ul>
    </div>

    <script>
        // v5ìš© ì €ì¥ì†Œ í‚¤ (ê¸°ì¡´ ë°ì´í„°ì™€ ì„ì´ì§€ ì•Šê²Œ ë¶„ë¦¬)
        let targets = JSON.parse(localStorage.getItem('myTargets_v5') || '[]');
        let currentRateValue = 0; 
        let wakeLock = null; 

        init();
        function init() {
            renderList();
            getRateProxy(); 
            // 20ì´ˆë§ˆë‹¤ ê°±ì‹  (ì„œë²„ ë¹„ìš© ì ˆì•½ + ì•ˆì •ì„±)
            setInterval(getRateProxy, 20000); 
        }

        async function getRateProxy() {
            try {
                // íˆ¬ììë‹˜ ì„œë²„ ì£¼ì†Œ (ê·¸ëŒ€ë¡œ ìœ ì§€)
                const myCloudUrl = 'https://my-rate-server-916720061652.us-central1.run.app'; 
                
                const res = await fetch(myCloudUrl);
                if (!res.ok) throw new Error("Error");
                const data = await res.json();
                
                const rate = data[0].basePrice;
                const change = data[0].change;
                const provider = data[0].provider;

                currentRateValue = rate; // í˜„ì¬ê°€ ì €ì¥

                const rateEl = document.getElementById('currentRate');
                const statusEl = document.getElementById('serverStatus');

                rateEl.innerText = rate.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                if (change === 'RISE') rateEl.className = 'up';
                else if (change === 'FALL') rateEl.className = 'down';
                else rateEl.className = 'even';

                statusEl.innerText = `âš¡ ì‹¤ì‹œê°„ (${provider})`;
                statusEl.className = "status-badge mode-live";

                checkAlert(rate);

            } catch (e) {
                console.error(e);
                document.getElementById('serverStatus').innerText = "ì¬ì ‘ì† ì¤‘...";
            }
        }

        // â˜…â˜…â˜… v5 í•µì‹¬ ìˆ˜ì •: ì¹¼ê°™ì€ ì •í™•ë„ ë¡œì§ â˜…â˜…â˜…
        function checkAlert(current) {
            targets.forEach(t => {
                if (t.notified) return; // ì´ë¯¸ ìš¸ë¦° ê±´ íŒ¨ìŠ¤

                let triggered = false;

                // 1. [ìƒìŠ¹ ëª©í‘œ] ì„¤ì • ì‹œ:
                // ì˜¤ì°¨ë²”ìœ„ ì‚­ì œ! ì •í™•íˆ ëª©í‘œê°€ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ ìš¸ë¦¼ (>=)
                // ì˜ˆ: ëª©í‘œ 1481, í˜„ì¬ 1480.99 -> ì•ˆ ìš¸ë¦¼
                if (t.direction === 'UP' && current >= t.price) {
                    triggered = true;
                }
                
                // 2. [í•˜ë½ ëª©í‘œ] ì„¤ì • ì‹œ:
                // ì •í™•íˆ ëª©í‘œê°€ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ ìš¸ë¦¼ (<=)
                // ì˜ˆ: ëª©í‘œ 1475, í˜„ì¬ 1475.1 -> ì•ˆ ìš¸ë¦¼
                else if (t.direction === 'DOWN' && current <= t.price) {
                    triggered = true;
                }

                if (triggered) {
                    doNotify(t.price, current, t.direction);
                    t.notified = true; // ì•Œë¦¼ ì™„ë£Œ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€)
                    saveData();
                    renderList();
                }
            });
        }

        function doNotify(target, current, dir) {
            // í™”ë©´ ë¹¨ê°„ìƒ‰ ê¹œë¹¡ì„ íš¨ê³¼
            document.body.classList.add('alert-bg');
            setTimeout(() => document.body.classList.remove('alert-bg'), 4000);
            
            const msg = dir === 'UP' ? "ğŸ“ˆ ëŒíŒŒ!" : "ğŸ“‰ ë„ë‹¬!";
            
            // ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼
            if (Notification.permission === "granted") {
                new Notification(`ğŸ’° ${target}ì› ${msg}`, { body: `í˜„ì¬ í™˜ìœ¨: ${current}ì›` });
            }
        }

        // â˜… ëª©í‘œ ì¶”ê°€ ì‹œ ë°©í–¥ ìë™ ê²°ì • â˜…
        function addTarget() {
            const val = parseFloat(document.getElementById('targetInput').value);
            if (!val) return;
            
            if (currentRateValue === 0) {
                alert("í™˜ìœ¨ ë¡œë”© í›„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
                return;
            }

            // í˜„ì¬ê°€ë³´ë‹¤ ë†’ìœ¼ë©´ UP, ë‚®ìœ¼ë©´ DOWN ìë™ ì„¤ì •
            // (1481ì› ëª©í‘œì¸ë° í˜„ì¬ 1480ì›ì´ë©´ -> UP ëª¨ë“œë¡œ ì €ì¥ë¨ -> 1480ì›ì¼ ë•Œ ì•ˆ ìš¸ë¦¼!)
            const dir = val > currentRateValue ? 'UP' : 'DOWN';

            targets.push({ price: val, direction: dir, notified: false });
            saveData();
            renderList();
            document.getElementById('targetInput').value = '';
        }

        function removeTarget(idx) {
            targets.splice(idx, 1);
            saveData();
            renderList();
        }

        function renderList() {
            const list = document.getElementById('targetList');
            list.innerHTML = '';
            targets.forEach((t, i) => {
                const li = document.createElement('li');
                li.style.opacity = t.notified ? "0.4" : "1";
                
                const dirIcon = t.direction === 'UP' ? 
                    "<span class='dir-badge dir-up'>â–²ìƒìŠ¹</span>" : 
                    "<span class='dir-badge dir-down'>â–¼í•˜ë½</span>";
                
                li.innerHTML = `<span>${dirIcon} ${t.price}ì›</span><button class="del-btn" onclick="removeTarget(${i})">ì‚­ì œ</button>`;
                list.appendChild(li);
            });
        }

        // í™”ë©´ ì¼œì§ ìœ ì§€ (Wake Lock)
        async function toggleWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock) {
                        wakeLock.release();
                        wakeLock = null;
                        document.getElementById('wakeBtn').classList.remove('wake-on');
                        document.getElementById('wakeBtn').innerText = "ğŸ“± í™”ë©´ ì¼œë‘ ";
                    } else {
                        wakeLock = await navigator.wakeLock.request('screen');
                        document.getElementById('wakeBtn').classList.add('wake-on');
                        document.getElementById('wakeBtn').innerText = "ğŸ’¡ ì¼œì§ ìœ ì§€ì¤‘";
                    }
                } catch (err) {
                    console.error(err);
                }
            } else {
                alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            }
        }

        function saveData() { localStorage.setItem('myTargets_v5', JSON.stringify(targets)); }
        function requestNoti() { Notification.requestPermission(); }
    </script>
</body>
</html>